# **Отчет о технической реализации и проверке концепции (PoC): Универсальный конвейер конвертации документов Markdown в форматы HTML, EPUB, FB2 и PDF**

## **1\. Введение и архитектурный контекст**

### **1.1 Цели и задачи исследования**

Настоящий отчет представляет собой детальное исследование технической осуществимости (Proof of Concept, PoC) создания единого конвейера конвертации технической документации. Основная задача заключается в трансформации исходных файлов в формате Markdown, обогащенных сложными элементами — фрагментами программного кода, динамическими диаграммами Mermaid и анимированными изображениями GIF, — в спектр конечных форматов: HTML, EPUB, FB2 и PDF. Актуальность исследования привязана к технологическому стеку декабря 2025 года, что подразумевает использование последних стабильных версий инструментов (Pandoc 3.x, Mermaid 11+, Python 3.12+) и современных подходов к автоматизации.  
В условиях современной разработки документация перестала быть статичным текстом. Инженеры и технические писатели требуют инструментов, позволяющих описывать архитектуру «как код» (diagrams-as-code), демонстрировать функциональность через анимацию и предоставлять примеры кода с точной подсветкой синтаксиса. Однако разнородность целевых платформ создает существенный технический барьер. Если веб\-форматы (HTML) нативно поддерживают современные медиа, то печатные (PDF) и устаревшие, но популярные в определенных регионах форматы электронных книг (FB2) накладывают жесткие ограничения. Цель данного PoC — доказать, что с помощью Pandoc и системы внешних фильтров можно преодолеть эти барьеры, обеспечив автоматическую адаптацию контента под возможности каждого формата.

### **1.2 Роль Pandoc и концепция AST**

Центральным элементом архитектуры выступает Pandoc — универсальный конвертер документов. Ключевой особенностью Pandoc, делающей данный PoC возможным, является его отказ от прямой трансляции одного формата в другой. Вместо этого Pandoc использует промежуточное представление — абстрактное синтаксическое дерево (Abstract Syntax Tree, AST).  
Процесс конвертации строго разделен на три фазы. На этапе чтения (Reader) Pandoc парсит входной Markdown-файл, преобразуя текстовые конструкции в типизированные узлы AST: Header (заголовки), Para (абзацы), CodeBlock (блоки кода), Image (изображения). Именно в этот момент абстрактное дерево становится доступным для программной модификации. Это открывает возможности для вмешательства в структуру документа до того, как он будет сериализован в конечный формат. На этапе фильтрации (Filter) применяются пользовательские скрипты, которые могут находить специфические узлы (например, код Mermaid или GIF-изображения) и трансформировать их. На финальном этапе записи (Writer) модифицированное дерево преобразуется в целевой формат (HTML, XML для FB2, LaTeX для PDF).  
Для реализации требований декабря 2025 года критически важно использование Lua-фильтров. В отличие от старых JSON-фильтров, требующих передачи данных через стандартные потоки ввода-вывода (pipe) внешним процессам, интерпретатор Lua встроен непосредственно в бинарный файл Pandoc. Это обеспечивает высокую производительность и отсутствие лишних зависимостей при базовых манипуляциях с AST. Однако, как показал анализ, для рендеринга Mermaid и обработки GIF возможностей встроенного Lua недостаточно, и архитектура неизбежно требует интеграции с внешними системными утилитами (Headless Chrome, ImageMagick).

### **1.3 Архитектура предлагаемого решения**

Для удовлетворения всех требований PoC предлагается многослойная архитектура конвейера. Базовый слой — это операционная система (предпочтительно Linux в контейнере Docker), предоставляющая необходимые бинарные зависимости: Node.js для запуска Mermaid CLI, Python для сложных скриптов обработки, TeX Live для компиляции PDF и ImageMagick для работы с растровой графикой.  
Второй слой — это логика фильтрации Pandoc. Здесь происходит маршрутизация контента. Фильтры анализируют метаданные документа и глобальные переменные среды, чтобы определить целевой формат вывода (FORMAT). Эта контекстная осведомленность критична: диаграмма Mermaid для HTML должна остаться векторным SVG для обеспечения масштабируемости и возможности выделения текста, в то время как для FB2 она обязана быть растрирована в PNG из\-за отсутствия поддержки векторов в спецификации FictionBook. Аналогично, GIF-анимация для PDF требует декомпозиции на кадры, тогда как для HTML она остается неизменной.  
Третий слой — это шаблоны и стили. Для каждого формата требуется свой набор конфигураций: CSS для HTML/EPUB, XML-шаблоны для FB2 и преамбулы LaTeX для PDF. Эти компоненты отвечают за визуальное представление (шрифты, отступы, цвета подсветки синтаксиса), которое должно быть согласованным во всех форматах, несмотря на различие технологий рендеринга.

## **2\. Анализ входных данных и спецификация Markdown**

### **2.1 Диалект Markdown и совместимость**

Выбор диалекта Markdown определяет возможности автора по структурированию документа. Для реализации задач PoC рекомендуется использование Pandoc's Markdown — расширенной версии синтаксиса, поддерживающей метаданные YAML, таблицы, сноски и атрибуты для блоков кода.  
Стандартный CommonMark, являющийся строгим подмножеством, недостаточен для профессиональной технической документации, так как не регламентирует синтаксис для атрибутов (например, указание ширины изображения или класса для диаграммы). Pandoc позволяет добавлять к элементам классы и идентификаторы, используя фигурные скобки {\#id.class key=value}. Это имеет решающее значение для фильтров: скрипт должен отличать блок кода Python, который нужно просто подсветить, от блока кода Mermaid, который нужно рендерить, основываясь исключительно на классе .mermaid.

### **2.2 Управление метаданными (YAML Front Matter)**

В начале каждого документа располагается блок YAML, содержащий библиографические данные и настройки конфигурации. В контексте PoC метаданные играют роль управляющих сигналов для конвейера. Для корректной генерации форматов EPUB и FB2 критически важно наличие полей title (название), author (автор) и lang (язык). Поле lang используется движками переносов в LaTeX и программами чтения (FBReader, Apple Books) для выбора правил произношения (TTS) и словарей.  
Пример конфигурации метаданных для PoC:

| Поле YAML | Назначение | Влияние на форматы |
| :---- | :---- | :---- |
| title | Заголовок документа | Обязателен для EPUB (OPF metadata) и FB2 (book-title). В PDF идет на титульный лист. |
| author | Автор | Обязателен для FB2 (first-name, last-name). Используется в метаданных PDF. |
| lang | Язык (напр. ru-RU) | Включает пакет babel в LaTeX (PDF). Определяет кодировку и переносы в FB2/EPUB. |
| mermaid-format | Формат диаграмм | Переопределяет дефолтный формат вывода Mermaid (svg/png) для конкретного документа. |
| header-includes | Инъекции кода | Добавляет \\usepackage{animate} в преамбулу LaTeX для поддержки GIF в PDF. |

Отсутствие этих данных приведет к валидационным ошибкам при генерации EPUB (через epubcheck) и созданию невалидных файлов FB2, которые могут быть отвергнуты строгими парсерами читалок.  
\---

## **3\. Техническая реализация подсветки синтаксиса (Code Blocks)**

Отображение исходного кода с подсветкой синтаксиса — базовое требование для технической документации. Pandoc обладает встроенной поддержкой этого функционала, однако реализация существенно различается в зависимости от выходного формата.

### **3.1 Механизм Skylighting (HTML и EPUB)**

Для HTML и EPUB Pandoc использует библиотеку skylighting, которая производит лексический анализ кода и разбивает его на токены. В выходной файл генерируется HTML-разметка, где каждому токену присваивается класс (например, \<span class="kw"\> для ключевых слов или \<span class="st"\> для строк).  
Преимущество данного метода заключается в гибкости стилизации. Цветовая схема не "запекается" в HTML-код, а выносится в CSS. Это позволяет менять тему подсветки (светлая/темная) без перегенерации контента, просто подменяя CSS-файл. Для EPUB, который по сути является архивом HTML-файлов, этот подход работает нативно. Однако стоит учитывать, что некоторые старые читалки EPUB могут игнорировать сложные CSS-правила, поэтому рекомендуется использовать контрастные и простые цветовые схемы.  
В рамках PoC для получения актуальных стилей 2025 года можно использовать команду pandoc \--print-highlight-style breezeDark \> syntax.css (или другую тему, например, espresso), что создаст JSON-подобный файл темы или CSS, который затем подключается при сборке.

### **3.2 LaTeX и PDF: Выбор движка**

При конвертации в PDF через LaTeX ситуация усложняется. Стандартный механизм Pandoc использует пакет listings, который имеет ограниченные возможности по работе с Unicode (что критично для комментариев на русском языке) и поддержке современных языков программирования.  
Для обеспечения профессионального качества ("publish-ready") в 2025 году стандартом де\-факто является пакет minted. Он использует мощнейший лексический анализатор Pygments (Python). Использование minted требует настройки Pandoc:

1. Указание пакета в метаданных или через \--include-in-header.  
2. Запуск pdflatex или xelatex с флагом \-shell-escape, так как minted вызывает внешний процесс Python во время компиляции.  
3. Настройка переноса длинных строк через \\setminted{breaklines=true}, иначе код будет уходить за пределы печатной области страницы, что является частой проблемой при PDF-конвертации.

Внедрение minted в конвейер PoC требует наличия Python и библиотеки Pygments в сборочном окружении (Docker-контейнере).

### **3.3 Ограничения формата FB2**

Формат FictionBook 2.0 (FB2) изначально разрабатывался для художественной литературы и не имеет семантических тегов для блоков кода. В спецификации XML-схемы FB2 версии 2.1 или 2.2 отсутствуют конструкции для цветного текста внутри абзацев. Большинство читалок (FBReader, CoolReader, PocketBook) отображают содержимое FB2, игнорируя любые попытки задать цвет шрифта.  
Следовательно, требование "подсветки синтаксиса" для FB2 технически невыполнимо в полной мере средствами формата. Стратегия PoC для FB2 заключается в "изящной деградации" (graceful degradation):

1. **Сохранение структуры:** Код должен быть выделен моноширинным шрифтом и отступами. Для этого используется тег \<code\> или \<subtitle\>, либо специальный стиль \<p style="font-family: monospace"\>.  
2. **Удаление цветов:** Фильтр должен очищать информацию о цветах, так как их передача невозможна.  
3. **Альтернатива (Растрирование):** Теоретически возможен вариант конвертации блока кода в изображение (PNG) с подсветкой и вставка его как картинки. Однако это нарушает доступность (текст нельзя скопировать, поиск не работает) и значительно увеличивает размер файла. Для данного PoC рекомендуется текстовое представление без подсветки как наиболее соответствующее философии формата FB2.

## **4\. Интеграция динамических диаграмм Mermaid**

Mermaid позволяет описывать диаграммы текстовым синтаксисом, что идеально для систем контроля версий. Однако ни один из целевых форматов (кроме, теоретически, HTML с JS-библиотекой) не умеет рендерить Mermaid нативно. Задача PoC — превратить текст в изображение *до* того, как документ попадет в финальный рендерер.

### **4.1 Архитектура фильтра Mermaid**

Наиболее эффективным решением является использование Lua-фильтра, который перехватывает блоки кода с классом .mermaid. Фильтр выполняет роль оркестратора между Pandoc и внешним инструментом рендеринга — Mermaid CLI (mmdc).  
Mermaid CLI базируется на Puppeteer (Headless Chrome), что позволяет получать результат, идентичный отображению в браузере. Процесс обработки одного блока выглядит следующим образом:

1. **Вычисление хеша:** Текст диаграммы хешируется (SHA-1). Это позволяет создать кеш изображений. Если диаграмма не менялась, фильтр просто использует существующий файл, экономя секунды на запуске тяжелого процесса Node.js.  
2. **Определение формата:** Фильтр проверяет переменную FORMAT (целевой формат Pandoc) и выбирает стратегию генерации.  
3. **Рендеринг:** Вызывается mmdc с параметрами \-i (stdin) \-o diagram.png/svg.  
4. **Подмена в AST:** Узел CodeBlock заменяется на узел Para, содержащий Image.

### **4.2 Стратегия выбора формата изображения**

Анализ показал, что универсального формата изображения не существует. Каждая цель требует своего подхода:

| Целевой формат | Формат диаграммы | Обоснование |
| :---- | :---- | :---- |
| **HTML** | **SVG** | Векторная графика обеспечивает идеальную четкость на любых экранах. Текст внутри SVG остается доступным для поиска и выделения. Возможна CSS-стилизация. |
| **EPUB** | **SVG** | Спецификация EPUB 3.3 поддерживает SVG как Core Media Type. Это позволяет диаграммам масштабироваться на экранах ридеров разного размера без пикселизации. |
| **PDF** | **PDF / High-Res PNG** | Вставка SVG в LaTeX через пакет svg возможна, но часто приводит к проблемам со шрифтами и прозрачностью. Более надежный путь для PoC — конвертация Mermaid сразу в векторный PDF с помощью mmdc или в PNG высокого разрешения (300 DPI). |
| **FB2** | **PNG** | FB2 не поддерживает векторную графику. Единственный вариант — растрирование в PNG (или JPG) и кодирование в Base64 внутри XML-файла. Фильтр должен принудительно выбирать PNG для цели fb2. |

### **4.3 Проблемы со шрифтами (Кириллица)**

При рендеринге диаграмм на сервере (в Docker-контейнере) частой проблемой является отсутствие шрифтов, поддерживающих кириллицу. В результате русский текст на диаграммах отображается "квадратиками" (tofu). Для успешного PoC Docker-образ обязан содержать пакеты шрифтов, такие как fonts-noto или fonts-liberation, а конфигурация mmdc должна ссылаться на эти шрифты в CSS.

## **5\. Обработка и трансформация анимации (GIF)**

Поддержка анимированных изображений (GIF) в печатных и устаревших форматах является одной из самых сложных технических задач данного исследования. Если для HTML и EPUB поддержка является нативной, то для PDF и FB2 требуется сложная предобработка контента.

### **5.1 PDF: Технология "Filmstrip" в LaTeX**

Формат PDF, ориентированный на печать, не имеет встроенного механизма воспроизведения GIF-анимации. Стандартные просмотрщики (Acrobat, Preview, PDF.js в браузере) отображают только первый кадр.  
Единственным рабочим решением для *отображения анимации* внутри PDF является использование LaTeX-пакета animate. Принцип его работы напоминает кинопленку: анимация внедряется как серия отдельных кадров, а JavaScript внутри PDF-файла переключает их с заданной частотой.  
**Алгоритм работы Lua-фильтра для PDF:**

1. **Детекция:** Фильтр находит узлы Image, ссылающиеся на файлы .gif.  
2. **Декомпозиция (ImageMagick):** Запускается команда magick convert \-coalesce input.gif frame\_%d.png. Опция \-coalesce критически важна: многие GIF-файлы оптимизированы и хранят только разницу между кадрами (дельта-кодирование). Без coalesce извлеченные кадры будут содержать прозрачные дыры вместо полного изображения.  
3. **Анализ метаданных:** Из GIF извлекается задержка между кадрами (delay) для расчета частоты кадров (FPS).  
4. **Генерация LaTeX-кода:** Узел Image заменяется на RawBlock (сырой LaTeX) с командой \\animategraphics.  
   * Пример: \\animategraphics\[autoplay,loop,width=\\linewidth\]{10}{frame\_}{0}{N}.  
5. **Ограничения:** Полученный PDF будет воспроизводить анимацию **только** в определенных просмотрщиках (Adobe Acrobat, PDF-XChange, Okular). В браузерах и мобильных приложениях анимация работать не будет. Это фундаментальное ограничение технологии PDF.

### **5.2 FB2: Проблема отсутствия динамики**

Формат FB2 хранит изображения как бинарные данные (Base64) внутри тега \<binary\>. Спецификация допускает MIME-тип image/gif. Однако подавляющее большинство аппаратных ридеров (E-ink устройства) и программных читалок игнорируют анимацию, отображая статичную картинку.  
Более того, внедрение полноценного анимированного GIF (который может весить 5-10 МБ) в текстовый XML-файл FB2 крайне неэффективно. Это приводит к раздуванию размера книги и проблемам с открытием файла на слабых устройствах.  
**Стратегия PoC:** Автоматическая конвертация в статику. Фильтр для FB2 должен принудительно конвертировать GIF в статический PNG (первый кадр или "poster frame"). Это гарантирует корректное отображение иллюстрации и уменьшает размер файла. Попытка сохранить анимацию в FB2 технически возможна (файл будет валидным), но практически бесполезна для конечного пользователя.

### **5.3 HTML и EPUB**

Для этих форматов вмешательство не требуется. Тег \<img src="animation.gif"\> поддерживается всеми браузерами и большинством движков EPUB3 (iBooks, Readium). Исключение составляют E-ink ридеры с поддержкой EPUB, где анимация будет тормозить из\-за низкой частоты обновления экрана, но это аппаратное, а не программное ограничение.

## **6\. Специфика генерации выходных форматов**

### **6.1 HTML5: Единый самодостаточный файл**

Для удобства распространения документации PoC рекомендует использование флага \--embed-resources (в старых версиях \--self-contained). Pandoc кодирует все изображения (включая сгенерированные Mermaid и GIF), скрипты и стили в Base64 и внедряет их в единственный HTML-файл.

* **Преимущества:** Файл можно отправить по почте, он не требует папки с ресурсами.  
* **Особенности:** Mermaid внедряется как SVG-код, что позволяет использовать CSS для изменения цветов линий и текста диаграммы при наведении курсора, обеспечивая интерактивность.

### **6.2 EPUB3: Современная электронная книга**

EPUB3 — это, по сути, веб\-сайт в ZIP-архиве.

* **Структура:** Pandoc автоматически генерирует файл манифеста content.opf, включая в него все сгенерированные изображения Mermaid.  
* **Валидация:** Для гарантии совместимости с магазинами (Apple Books, Google Play) полученный файл необходимо проверять утилитой epubcheck. Частая ошибка — использование абсолютных путей к картинкам в Markdown; Lua-фильтр должен приводить их к относительным путям внутри контейнера EPUB.  
* **Совместимость:** Спецификация EPUB 3.3 полностью поддерживает современные веб\-технологии, что делает этот формат наиболее близким по возможностям к HTML.

### **6.3 FictionBook 2.0 (FB2): Наследие и ограничения**

Генерация FB2 через Pandoc требует особого внимания, так как нативный писатель (writer) Pandoc для FB2 имеет ряд исторических проблем.

* **Схема:** FB2 требует строгого порядка элементов. Например, title\[span\_11\](start\_span)\[span\_11\](end\_span)-info должен идти перед body. Pandoc берет эти данные из YAML-метаданных, но если какое-то поле отсутствует или имеет неверный тип, XML может не пройти валидацию схемой (XSD).  
* **Base64:** Все изображения (Mermaid PNG, статические версии GIF) должны быть собраны фильтром. Pandoc автоматически кодирует локальные изображения в Base64 и помещает их в секцию \<binary\>, присваивая им уникальные ID. Ссылки в тексте заменяются на \<image l:href="\#id"/\>.  
* **Вердикт:** FB2 является "форматом с потерями" для данного PoC. Интерактивность и анимация невозможны, подсветка кода теряется. Это необходимо зафиксировать как архитектурное ограничение.

### **6.4 PDF: Сравнение движков**

В ходе исследования сравнивались два подхода к генерации PDF:

1. **LaTeX (xelatex/pdflatex):**  
   * *Плюсы:* Идеальная типографика, поддержка CMYK (для печати), возможность анимации через пакет animate.  
   * *Минусы:* Сложность настройки, большой размер дистрибутива (TeX Live занимает гигабайты), медленная компиляция.  
   * *Вердикт:* Рекомендуемый выбор для данного PoC из\-за требования поддержки GIF-анимации.  
2. **WeasyPrint (HTML-to-PDF):**  
   * *Плюсы:* Использует CSS для верстки (проще для веб\-разработчиков), легкий, быстрый, поддерживает современные веб\-стандарты.  
   * *Минусы:* **Не поддерживает GIF-анимацию** (рендерит только первый кадр).  
   * *Вердикт:* Подходит только если требование к анимации в PDF можно снять. В рамках данного ТЗ (строгое требование GIF) WeasyPrint не подходит.

## **7\. Оркестрация, автоматизация и CI/CD**

Учитывая сложность зависимостей (Haskell, Node.js, Python, TeX), ручная настройка окружения на машине каждого разработчика приведет к проблемам "works on my machine". Единственным надежным способом поставки данного решения является контейнеризация.

### **7.1 Docker-образ для конвертации**

Предлагается создание специализированного Docker-образа, объединяющего все инструменты.  
**Спецификация Dockerfile:**  
`# Базовый образ с Pandoc и минимальным TeX`  
`FROM pandoc/extra:3.1-ubuntu`

`# Установка системных зависимостей`  
`# nodejs - для Mermaid CLI`  
`# python3-pygments - для подсветки кода (minted)`  
`# imagemagick - для обработки GIF`  
`# fonts-noto - для поддержки кириллицы в диаграммах`  
`RUN apt-get update && apt-get install -y \`  
    `nodejs npm \`  
    `python3-pip \`  
    `imagemagick \`  
    `ghostscript \`  
    `fonts-noto-core \`  
    `fonts-liberation \`  
    `&& rm -rf /var/lib/apt/lists/*`

`# Установка Mermaid CLI (Puppeteer скачает свой Chromium)`  
`RUN npm install -g @mermaid-js/mermaid-cli`

`# Установка Pygments для LaTeX minted`  
`RUN pip3 install Pygments --break-system-packages`

`# Настройка ImageMagick (разрешение на чтение/запись PDF/иных форматов)`  
`RUN sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/' /etc/ImageMagick-6/policy.xml`

`WORKDIR /workspace`  
`ENTRYPOINT ["pandoc"]`

### **7.2 Сценарий сборки (Makefile)**

Для автоматизации запуска Pandoc с длинными цепочками аргументов и фильтров используется Makefile. Это позволяет стандартизировать команды сборки.  
`# Переменные для конфигурации`  
`PANDOC_OPTS = --standalone --embed-resources`  
`FILTERS = --lua-filter=filters/mermaid.lua --lua-filter=filters/gif-handler.lua`

`# Цель: HTML`  
`html:`  
	`pandoc input.md -o output.html -t html5 $(PANDOC_OPTS) $(FILTERS) \`  
	`--highlight-style=breezedark --css=styles/main.css`

`# Цель: PDF (с анимацией)`  
`pdf:`  
	`pandoc input.md -o output.pdf -t latex $(FILTERS) \`  
	`--pdf-engine=xelatex \`  
	`--variable mainfont="Noto Serif" \`  
	`--variable monofont="Fira Code" \`  
	`--include-in-header=styles/preamble.tex \`  
	`-V geometry:margin=2cm`

`# Цель: FB2 (статические картинки)`  
`fb2:`  
	`pandoc input.md -o output.fb2 -t fb2 $(FILTERS) \`  
	`--variable lang="ru-RU"`

`# Цель: EPUB`  
`epub:`  
	`pandoc input.md -o output.epub -t epub3 $(FILTERS) \`  
	`--epub-cover-image=cover.jpg`

Этот подход позволяет легко интегрировать процесс конвертации в CI/CD системы (GitLab CI, GitHub Actions), где при каждом коммите документации в репозиторий автоматически запускается сборка всех форматов артефактов.

## **8\. Итоговая оценка осуществимости и матрица совместимости**

Проведенное исследование подтверждает, что задача конвертации Markdown-файлов со сложным контентом в HTML, EPUB, FB2 и PDF **технически осуществима** в стеке технологий 2025 года. Однако "бесшовная" конвертация невозможна "из коробки" и требует разработки специализированного промежуточного слоя (Lua-фильтры) и подготовки среды выполнения.

### **8.1 Матрица реализации требований**

Ниже приведена сводная таблица того, как каждое требование реализуется в каждом из целевых форматов.

| Требование / Формат | HTML5 | EPUB3 | FB2 | PDF (LaTeX) |
| :---- | :---- | :---- | :---- | :---- |
| **Базовый текст (Markdown)** | Нативная поддержка | Нативная поддержка | Нативная поддержка | Нативная поддержка |
| **Подсветка кода** | Полная (CSS classes). Динамическая смена тем. | Полная (CSS). Зависит от движка ридера. | **Отсутствует**. Конвертация в моноширинный текст без цветов. | Полная (Minted/Listings). Высокое полиграфическое качество. |
| **Диаграммы Mermaid** | **Вектор (SVG)**. Возможно внедрение JS для интерактива. | **Вектор (SVG)**. Хорошая поддержка в современных ридерах. | **Растр (PNG)**. Требуется принудительная конвертация фильтром. | **Вектор (PDF/SVG)**. Требуется конвертация во избежание артефактов рендеринга. |
| **GIF Анимация** | **Нативная**. \<img src=".gif"\> работает везде. | **Нативная**. Поддерживается стандартом, зависит от устройства. | **Статика**. Конвертация в постер-кадр (PNG). Анимация невозможна. | **Специфичная**. Требует разложения на кадры \+ пакет animate. Работает только в Adobe Reader/Okular. |
| **Сложность реализации** | Низкая | Средняя (структура OCF) | Средняя (строгая XML схема) | Высокая (зависимости TeX, шрифты, обработка GIF) |

### **8.2 Заключение и рекомендации**

Для успешного внедрения данного решения в производственный процесс рекомендуется:

1. **Принять ограничения FB2:** Не пытаться реализовать в нем функции, не поддерживаемые форматом (цветной код, анимация), а обеспечить качественный фоллбек (fallback) к читаемому статичному контенту.  
2. **Использовать Lua-фильтры:** Отказаться от JSON-фильтров на Python в пользу Lua для ускорения сборки и упрощения дистрибуции.  
3. **Контейнеризация:** Использовать Docker как единственный способ распространения инструментария конвертации, чтобы исключить конфликты версий системных библиотек (особенно для TeX и Node.js).  
4. **Валидация:** Встроить в пайплайн шаги валидации (xmllint для FB2, epubcheck для EPUB), так как Pandoc может сгенерировать синтаксически верный, но структурно некорректный файл для конкретного стандарта.

Данный PoC демонстрирует, что Pandoc остается мощнейшим инструментом в классе "швейцарских ножей" для документов, способным, при должной настройке, решать задачи промышленного уровня сложности.

#### **Источники**

1\. Pandoc User's Guide, https://pandoc.org/MANUAL.html 2\. Mermaid Lua Filter \- Zettlr Discussion Forum, https://forum.zettlr.com/d/84-mermaid-lua-filter 3\. Pandoc Lua Filters, https://pandoc.org/lua-filters.html 4\. FB2 \- MobileRead Wiki, https://wiki.mobileread.com/wiki/FB2 5\. Pandoc \- index, https://pandoc.org/ 6\. Pandoc filter for creating diagrams in mermaid syntax blocks in markdown docs \- GitHub, https://github.com/raghur/mermaid-filter 7\. fb2 produced by pandoc doesn't validate · Issue \#2424 \- GitHub, https://github.com/jgm/pandoc/issues/2424 8\. Pandoc: Converting markdown to HTML, syntax highlighter \- Stack Overflow, https://stackoverflow.com/questions/12311344/pandoc-converting-markdown-to-html-syntax-highlighter 9\. Demos \- Pandoc, https://pandoc.org/demos.html 10\. AUR (en) \- mermaid-filter \- Arch Linux, https://aur.archlinux.org/packages/mermaid-filter 11\. The animate Package \- CTAN, https://tug.ctan.org/macros/latex/contrib/animate/animate.pdf 12\. Is there any way to include an animated GIF directly? \- LaTeX Stack Exchange, https://tex.stackexchange.com/questions/5396/is-there-any-way-to-include-an-animated-gif-directly 13\. How can I split an animated .gif file into its component frames? \- Ask Ubuntu, https://askubuntu.com/questions/101526/how-can-i-split-an-animated-gif-file-into-its-component-frames 14\. Is it possible to embed animated GIFs in PDFs? \[closed\] \- Stack Overflow, https://stackoverflow.com/questions/9009771/is-it-possible-to-embed-animated-gifs-in-pdfs 15\. Rakuten Kobo eReader Store United States, https://us.kobobooks.com/collections/ereaders 16\. Animated Storybooks \- Apple Education Community, https://education.apple.com/resource/250010951 17\. EPUB Reading Systems 3.3 \- W3C on GitHub, https://w3c.github.io/epub-specs/epub33/rs/ 18\. EPUB 3.3 is here\! \- EPUBSecrets, https://epubsecrets.com/epub-3-3-is-here.php 19\. Generating PDF documents from Markdown \- ROllerozxa, https://voxelmanip.se/2025/04/22/generating-pdf-documents-from-markdown/ 20\. Hi everyone. Is there a file type, similar to PDF's or something, that allows animated GIF's?, https://www.reddit.com/r/software/comments/1abl8bi/hi\_everyone\_is\_there\_a\_file\_type\_similar\_to\_pdfs/