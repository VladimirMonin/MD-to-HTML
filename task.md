# Техническое описание реализации Diff-блоков

В этом документе описывается текущий механизм работы блоков сравнения кода (side-by-side diff), реализованный в проекте.

## 1. Общая архитектура

Решение представляет собой гибридный подход, где серверная часть (Python) подготавливает базовую HTML-структуру, а клиентская часть (JavaScript) выполняет основную работу по сравнению и отображению различий.

**Ключевой принцип:** Позволить библиотеке `highlight.js` первой выполнить свою задачу (подсветку синтаксиса), и только после этого модифицировать DOM для отображения `diff`-эффекта. Это позволяет избежать конфликтов между скриптами.

## 2. Серверная часть (`main.py`)

Задача Python-скрипта — распознать `diff`-блок в Markdown и преобразовать его в простую, но структурированную HTML-разметку.

### Входные данные

Скрипт ожидает на входе Markdown-блок, размеченный как `diff` с опциональным указанием языка.

**Пример:**
````markdown
```diff-python
- squares = []
- for i in range(10):
-   squares.append(i * i)
+ squares = [i * i for i in range(10)]
```
````

### Логика работы (`DiffPreprocessor`)

1.  **Распознавание блока:** Препроцессор находит блоки, начинающиеся с ` ```diff `. Он также извлекает язык (например, `python`), если он указан через дефис.
2.  **Разделение кода:** Содержимое блока делится на два списка строк:
    *   `before_code`: Все строки, не начинающиеся с `+`.
    *   `after_code`: Все строки, не начинающиеся с `-`.
    При этом сами маркеры `+` и `-` и следующий за ним пробел удаляются.
3.  **Генерация HTML:** Скрипт генерирует следующую HTML-структуру:
    *   Создается основной контейнер `<div class="diff-wrapper">`.
    *   Внутри него создаются два `<div class="diff-container">` для колонок "Было" и "Стало".
    *   В каждый контейнер помещается тег `<pre><code class="language-..."></code></pre>`.
    *   **Важно:** Внутрь тегов `<code>` вставляется **чистый, неформатированный текст** из `before_code` и `after_code`. Язык, извлеченный на шаге 1, используется для подстановки в класс (например, `language-python`).
4.  **Экранирование:** Весь код, вставляемый в `<code>`, проходит через функцию экранирования HTML-символов (`<`, `>`, `&`), чтобы браузер отображал его как текст, а не пытался интерпретировать как теги.

### Выходные данные (HTML)

На выходе Python генерирует "каркас", готовый для дальнейшей обработки на клиенте.

```html
<div class="diff-wrapper">
    <div class="diff-container">
        <div class="diff-header">Было</div>
        <pre><code class="language-python">squares = []
for i in range(10):
  squares.append(i * i)</code></pre>
    </div>
    <div class="diff-container">
        <div class="diff-header">Стало</div>
        <pre><code class="language-python">squares = [i * i for i in range(10)]</code></pre>
    </div>
</div>
```

## 3. Клиентская часть (`assets/js/diff_highlight.js`)

Этот скрипт выполняет всю основную работу по сравнению и визуализации. Он спроектирован так, чтобы запускаться после полной отрисовки страницы и завершения работы `highlight.js`.

### Порядок выполнения

1.  **Задержка:** Скрипт запускается с небольшой задержкой (`setTimeout`) после события `DOMContentLoaded`, чтобы гарантировать, что все элементы на странице, включая блоки кода, уже существуют.
2.  **Подсветка синтаксиса:** Первым делом принудительно запускается `hljs.highlightElement()` для всех блоков `<pre><code>`. На этом этапе `highlight.js` преобразует текстовое содержимое `<code>` в сложную структуру из `<span>` с классами для подсветки.
3.  **Подсветка Diff:** Сразу после этого вызывается функция `window.applyDiffHighlight()`.
4.  **Синхронизация высоты:** В самом конце вызывается `window.syncDiffBlockHeights()`.

### Логика работы (`applyDiffHighlight`)

1.  **Получение текста:** Скрипт находит пары блоков `<code>` внутри каждого `.diff-wrapper` и извлекает их **текстовое содержимое** (`.textContent`). На этом этапе мы получаем уже чистый текст, без HTML-тегов подсветки.
2.  **Сравнение:** Тексты "до" и "после" сравниваются с помощью библиотеки `diff_match_patch`.
3.  **Генерация HTML с Diff:** Результат сравнения (массив изменений) преобразуется в новый HTML.
    *   Неизмененные части текста (`op === 0`) остаются как есть.
    *   Удаленные (`op === -1`) и добавленные (`op === 1`) части оборачиваются в `<span class="diff-sub">` или `<span class="diff-add">`.
4.  **Перезапись содержимого:** Сгенерированный HTML **полностью перезаписывает** (`.innerHTML = ...`) содержимое тегов `<code>`. Так как `highlight.js` уже отработал, его `<span>` удаляются, но так как `diff_match_patch` вернул нам текст с сохраненными пробелами и переносами, визуально форматирование кода не страдает. Подсветка синтаксиса при этом теряется, но остается подсветка изменений.
5.  **Экранирование:** При генерации HTML на этом шаге также применяется экранирование, чтобы избежать XSS-уязвимостей.

### Логика работы (`syncDiffBlockHeights`)

1.  **Поиск блоков:** Скрипт находит все пары тегов `<pre>` внутри `.diff-wrapper`.
2.  **Измерение:** Высота обоих блоков сбрасывается на `auto`, после чего измеряется их реальная высота (`.scrollHeight`).
3.  **Применение высоты:** Максимальная из двух высот применяется к обоим блокам, заставляя их визуально выровняться.
4.  **События:** Эта функция также привязана к событию `resize` окна браузера, чтобы блоки пересчитывали высоту при изменении размеров окна.
